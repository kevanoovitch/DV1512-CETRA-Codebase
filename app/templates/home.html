{% extends "base.html" %}
{% block title %}Home – CETRA{% endblock %}

{% block content %}
<h1>Home</h1>

<div class="card home-card">
  <p>Welcome to CETRA — analyze a Chrome extension by uploading a file or entering an ID.</p>

  <div class="submit-section">
    <h2>Submit an Extension</h2>

    <form action="{% url 'home' %}" method="post" enctype="multipart/form-data" class="submit-form">
      {% csrf_token %}
      <div class="submit-row">
        
        <select name="submit_type" class="select-input" required>
          <option value="id" selected>Extension ID</option>
          <option value="zip">ZIP File</option>
          <option value="crx">CRX File</option>
        </select>

        <input type="text" name="submission_value" placeholder="Enter Chrome Web Store ID" required>
        <input type="file" name="submission_file" accept=".zip,.crx" class="file-input">

        <button type="submit" class="btn-pill btn-accent">Submit</button>
      </div>
    </form>

    <div class="status-area">
      <p id="run-status" class="status-banner info is-hidden"></p>
      {% if status_message %}
        <p class="status-banner success">{{ status_message }}</p>
      {% endif %}

      {% if error %}
        <p class="status-banner error">{{ error }}</p>
      {% endif %}
    </div>
  </div>
</div>

<div class="card top-list">
  <h2>Top 5 Highest Scores</h2>
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Score</th>
          <th>File Hash</th>
          <th>Extension ID</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        {% if top_reports %}
          {% for r in top_reports %}
            <tr>
              <td>
                <div class="score">
                  <span class="score-text">{{ r.score}}</span>
                </div>
              </td>
              <td class="mono">{{ r.file_hash }}</td>
              <td class="mono">{{ r.extention_id }}</td>
              <td>{{ r.date}}</td>
            </tr>
          {% endfor %}
        {% else %}
          {% for _ in "12345" %}
            <tr class="skeleton">
              <td><div class="skeleton-bar w-15"></div></td>
              <td><div class="skeleton-bar w-60"></div></td>
              <td class="mono"><div class="skeleton-bar w-40"></div></td>
              <td><div class="skeleton-bar w-30"></div></td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
  const select = document.querySelector('.select-input');
  const textField = document.querySelector('input[name="submission_value"]');
  const fileField = document.querySelector('input[name="submission_file"]');
  const form = document.querySelector('.submit-form');
  const runStatus = document.getElementById('run-status');

  function toggleInputs() {
    if (select.value === 'id') {
      textField.style.display = 'block';
      fileField.style.display = 'none';
      textField.required = true;
      fileField.required = false;
    } else {
      textField.style.display = 'none';
      fileField.style.display = 'block';
      textField.required = false;
      fileField.required = true;
    }
  }

  toggleInputs();
  select.addEventListener('change', toggleInputs);

  if (form && runStatus) {
    form.addEventListener('submit', function () {
      runStatus.classList.remove('is-hidden');
      runStatus.textContent = 'Upload successful. Analysis has started...';
    });
  }
</script>
{% endblock %}
