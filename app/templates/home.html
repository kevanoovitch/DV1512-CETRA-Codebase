{% extends "base.html" %}
{% load hash_filters %}
{% block title %}Home – CETRA{% endblock %}

{% block content %}
<h1>Home</h1>

<div class="card home-card">
  <p>Welcome to CETRA — analyze a Chrome extension by uploading a file or entering an ID.</p>

  <div class="submit-section">
    <h2>Submit an Extension</h2>

    <form action="{% url 'home' %}" method="post" enctype="multipart/form-data" class="submit-form">
      {% csrf_token %}
      <div id="submit-row" class="submit-row">
        
        <select name="submit_type" class="select-input" required>
          <option value="id" selected>Extension ID</option>
          <option value="zip">ZIP File</option>
          <option value="crx">CRX File</option>
        </select>

        <input type="text" name="submission_value" placeholder="Enter Chrome Web Store ID" required>
        <input type="file" name="submission_file" accept=".zip,.crx" class="file-input">
        
        <button id="submit-btn" type="submit" class="btn-pill btn-accent">Submit</button>
      </div>
    </form>

    <div class="status-area">
        <div class="inline-status">
          <div id="loader" class="loader hidden"></div>
          <span id="run-status" class="status-text is-hidden"></span>
        </div>

        {% if status_message %}
            <p class="status-banner success">{{ status_message }}</p>
        {% endif %}

        {% if unsupported_extension %}
            <p class="status-banner unsupported">
              This extension is not on the Chrome Web Store and thus is not supported.
            </p>
        {% endif %}

        {% if error %}
            <p class="status-banner error">{{ error }}</p>
        {% endif %}
    </div>
  </div>
</div>

{% if existing_report %}
<div class="card info-card" style="
    margin-top: 20px;
    margin-bottom: 20px;
    text-align: center;
    padding: 25px;
  ">
    <h3 style="margin-bottom: 10px;">Existing Report Found</h3>
    <p>A report from the last 30 days already exists.</p>

    <p style="margin-top: 10px;">
        <strong>Date:</strong> {{ report_date }}<br>
        <strong>Hash:</strong> {{ hash }}
    </p>

    <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
        <a class="btn btn-sm btn-accent btn-pill" href="{% url 'report' %}{{ hash }}">
            Open Report
        </a>
        <form method="post" action="{% url 'home' %}">
            {% csrf_token %}
            <input type="hidden" name="force" value="true">
            <input type="hidden" name="extention_id" value="{{ extention_id }}">
            <input type="hidden" name="file_path" value="{{ file_path }}">
            <button class="btn btn-sm btn-accent btn-pill">Run New Analysis</button>
        </form>

    </div>
  </div>
{% endif %}


<div class="card top-list">
  <h2>Top 5 Highest Scores</h2>
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Score</th>
          <th>File Hash</th>
          <th>Extension ID</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        {% if top_reports %}
          {% for r in top_reports %}
            <tr>
              <td><div class="score"><span class="score-text">{{ r.score}}</span></div></td>
              <td>{{ r.file_hash|short_hash }}</td>
              <td>{{ r.extention_id }}</td>
              <td>{{ r.date}}</td>
            </tr>
          {% endfor %}
        {% else %}
          {% for _ in "12345" %}
            <tr class="skeleton">
              <td><div class="skeleton-bar w-15"></div></td>
              <td><div class="skeleton-bar w-60"></div></td>
              <td class="mono"><div class="skeleton-bar w-40"></div></td>
              <td><div class="skeleton-bar w-30"></div></td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
  const select = document.querySelector('.select-input');
  const textField = document.querySelector('input[name="submission_value"]');
  const fileField = document.querySelector('input[name="submission_file"]');
  const form = document.querySelector('.submit-form');
  const runStatus = document.getElementById('run-status');
  const loader = document.getElementById('loader');
  const submitBtn = document.getElementById('submit-btn');

  function toggleInputs() {
    if (select.value === 'id') {
      textField.style.display = 'block';
      fileField.style.display = 'none';
      textField.required = true;
      fileField.required = false;
    } else {
      textField.style.display = 'none';
      fileField.style.display = 'block';
      textField.required = false;
      fileField.required = true;
    }
  }

  toggleInputs();
  select.addEventListener('change', toggleInputs);
  
  form.addEventListener('submit', function () {
    document.querySelector('.inline-status').classList.add('active');
    loader.classList.remove('hidden');
    runStatus.classList.remove('is-hidden');
    runStatus.textContent = 'Analyzing extension…';
    const row = document.getElementById('submit-row');
    row.classList.add('disabled-section');
    submitBtn.classList.add('disabled-tooltip');
  });
</script>

{% endblock %}
